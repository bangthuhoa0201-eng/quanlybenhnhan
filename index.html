<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý bệnh nhân</title>

    <style>
        body {
            font-family: Arial;
            background: #f0f2f5;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }

        th {
            background: #4CAF50;
            color: white;
        }

        form {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
        }

        input, select {
            padding: 6px;
            margin: 4px;
        }

        button {
            padding: 6px 10px;
            border: none;
            cursor: pointer;
            color: white;
        }

        .them {
            background: #4CAF50;
        }

        .xoa {
            background: red;
        }

        .sua {
            background: orange;
        }

        .lichsu {
            background: blue;
        }
    </style>
</head>

<body>

    <h2>🏥 Hệ thống quản lý bệnh nhân</h2>

    <input id="timkiem" placeholder="Tìm bệnh nhân..." onkeyup="timBenhNhan()">

    <form onsubmit="themHoacSua(event)">

        <input id="ten" placeholder="Tên bệnh nhân" required>

        <input id="tuoi" type="number" placeholder="Tuổi" required>

        <select id="donvituoi">
            <option value="t">Tuổi (t)</option>
            <option value="th">Tháng (th)</option>
        </select>

        <input id="chieucao" type="number" placeholder="Chiều cao (cm)" required>
        <input id="cannang" type="number" placeholder="Cân nặng (kg)" required>

        <select id="gioitinh">
            <option>Nam</option>
            <option>Nữ</option>
            <option>Khác</option>
        </select>

        <input id="ngaykham" type="date" required>
        <input id="chuandoan" placeholder="Chuẩn đoán" required>
        <input id="thuoc" placeholder="Thuốc điều trị" required>

        <button id="nutThem" class="them">Thêm</button>

    </form>

    <table id="bangBenhNhan">

        <tr>
            <th>Tên</th>
            <th>Tuổi</th>
            <th>Chiều cao</th>
            <th>Cân nặng</th>
            <th>Ngày khám</th>
            <th>Chuẩn đoán</th>
            <th>Giới tính</th>
            <th>Thuốc</th>
            <th>Lịch sử</th>
            <th>Sửa</th>
            <th>Xóa</th>
        </tr>

    </table>

    <script>

        let danhSach = [];
        let indexDangSua = -1;

        window.onload = function () {

            let data = localStorage.getItem("benhnhan");

            if (data) {
                danhSach = JSON.parse(data);
                hienThi();
            }

        }

        function themHoacSua(event) {

            event.preventDefault();

            let bn = {
                ten: ten.value,
                tuoi: tuoi.value,
                donvi: donvituoi.value,
                chieucao: chieucao.value,
                cannang: cannang.value,
                gioitinh: gioitinh.value,
                lichsu: [
                    {
                        ngaykham: ngaykham.value,
                        chuandoan: chuandoan.value,
                        thuoc: thuoc.value
                    }
                ]
            };

            if (indexDangSua === -1) {

                danhSach.push(bn);

            } else {

                danhSach[indexDangSua].lichsu.push({
                    ngaykham: ngaykham.value,
                    chuandoan: chuandoan.value,
                    thuoc: thuoc.value
                });

                indexDangSua = -1;
                nutThem.innerText = "Thêm";
            }

            luuDuLieu();
            hienThi();
            document.querySelector("form").reset();

        }

        function hienThi() {

            let bang = document.getElementById("bangBenhNhan");

            bang.innerHTML = `
<tr>
<th>Tên</th>
<th>Tuổi</th>
<th>Chiều cao</th>
<th>Cân nặng</th>
<th>Ngày khám</th>
<th>Chuẩn đoán</th>
<th>Giới tính</th>
<th>Thuốc</th>
<th>Lịch sử</th>
<th>Sửa</th>
<th>Xóa</th>
</tr>`;

            danhSach.forEach((bn, index) => {

                let lanCuoi = bn.lichsu[bn.lichsu.length - 1];

                let hang = bang.insertRow();

                hang.insertCell(0).innerText = bn.ten;
                hang.insertCell(1).innerText = bn.tuoi + " " + bn.donvi;
                hang.insertCell(2).innerText = bn.chieucao + " cm";
                hang.insertCell(3).innerText = bn.cannang + " kg";
                hang.insertCell(4).innerText = lanCuoi.ngaykham;
                hang.insertCell(5).innerText = lanCuoi.chuandoan;
                hang.insertCell(6).innerText = bn.gioitinh;
                hang.insertCell(7).innerText = lanCuoi.thuoc;

                let nutLS = document.createElement("button");
                nutLS.innerText = "📜";
                nutLS.className = "lichsu";
                nutLS.onclick = () => xemLichSu(index);
                hang.insertCell(8).appendChild(nutLS);

                let nutSua = document.createElement("button");
                nutSua.innerText = "✏️";
                nutSua.className = "sua";
                nutSua.onclick = () => suaBenhNhan(index);
                hang.insertCell(9).appendChild(nutSua);

                let nutXoa = document.createElement("button");
                nutXoa.innerText = "❌";
                nutXoa.className = "xoa";
                nutXoa.onclick = () => xoaBenhNhan(index);
                hang.insertCell(10).appendChild(nutXoa);

            });

        }

        function suaBenhNhan(index) {

            let bn = danhSach[index];

            let lanCuoi = bn.lichsu[bn.lichsu.length - 1];

            ten.value = bn.ten;
            tuoi.value = bn.tuoi;
            donvituoi.value = bn.donvi;
            chieucao.value = bn.chieucao;
            cannang.value = bn.cannang;
            gioitinh.value = bn.gioitinh;

            ngaykham.value = lanCuoi.ngaykham;
            chuandoan.value = lanCuoi.chuandoan;
            thuoc.value = lanCuoi.thuoc;

            indexDangSua = index;
            nutThem.innerText = "Cập nhật";

        }

        function xoaBenhNhan(index) {

            if (confirm("Xóa bệnh nhân?")) {
                danhSach.splice(index, 1);
                luuDuLieu();
                hienThi();
            }

        }

        function xemLichSu(index) {

            let bn = danhSach[index];

            let text = "Lịch sử khám của " + bn.ten + "\n\n";

            bn.lichsu.forEach(ls => {
                text += "Ngày: " + ls.ngaykham + "\n";
                text += "Chuẩn đoán: " + ls.chuandoan + "\n";
                text += "Thuốc: " + ls.thuoc + "\n\n";
            });

            alert(text);

        }

        function timBenhNhan() {

            let input = timkiem.value.toLowerCase();
            let rows = document.querySelectorAll("#bangBenhNhan tr");

            rows.forEach((row, index) => {
                if (index === 0) return;

                let ten = row.cells[0].innerText.toLowerCase();
                row.style.display = ten.includes(input) ? "" : "none";

            });

        }

        function luuDuLieu() {
            localStorage.setItem("benhnhan", JSON.stringify(danhSach));
        }

    </script>

</body>
</html>
